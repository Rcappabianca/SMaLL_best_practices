

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>1. Deep Learing with Colab (an introduction) &mdash; SMaLL best practice latest documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/mystnb.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/togglebutton.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="prev" title="Tutorials" href="../index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../quick_start/index.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced_topics/index.html">Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_contribute/index.html">How to contribute</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">1. Deep Learing with Colab (an introduction)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cnn-in-a-glance">1.1. CNN in a glance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#convolution-layer">1.1.1. Convolution layer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pooling-layer">1.1.2. Pooling layer</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#colab">1.2. Colab</a></li>
<li class="toctree-l3"><a class="reference internal" href="#handwritten-number-recognition-with-cnn">1.3. Handwritten number recognition with CNN</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#environment-set-up">1.3.1. Environment set-up</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-collection-and-preprocessing">1.3.2. Data collection and preprocessing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#model-building">1.3.3. Model building</a></li>
<li class="toctree-l4"><a class="reference internal" href="#model-compiling">1.3.4. Model compiling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#training">1.3.5. Training</a></li>
<li class="toctree-l4"><a class="reference internal" href="#results">1.3.6. Results</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#excercise">1.4. Excercise</a><ul class="simple">
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SMaLL best practice</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Tutorials</a> &raquo;</li>
        
      <li><span class="section-number">1. </span>Deep Learing with Colab (an introduction)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/pages/tutorials/2021-03-22-Deep_Learing_with_Colab/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="deep-learing-with-colab-an-introduction">
<h1><span class="section-number">1. </span>Deep Learing with Colab (an introduction)<a class="headerlink" href="#deep-learing-with-colab-an-introduction" title="Permalink to this headline">¶</a></h1>
<p>This tutorial demonstrates training a simple <a class="reference external" href="https://en.wikipedia.org/wiki/Convolutional_neural_network">Convolutional Neural Network</a> (CNN) to classify <a class="reference external" href="https://en.wikipedia.org/wiki/MNIST_database">MNIST Dataset</a>.</p>
<div class="section" id="cnn-in-a-glance">
<h2><span class="section-number">1.1. </span>CNN in a glance<a class="headerlink" href="#cnn-in-a-glance" title="Permalink to this headline">¶</a></h2>
<p>The Convolutional Neural Network (CNN) is a class of Deep Learning Netower extensively used in image analysis (Computer Vision).
The main feature is the Convolution Layer, which replaces the classic Perceptron (i.e., the “Neuron” of a Neural Network) with a “Filter”
containing the “weights” that convolute the input from the previous layer <a class="reference internal" href="#cnn-example"><span class="std std-numref">Fig. 1.7</span></a>.</p>
<div class="figure align-center" id="id2">
<span id="cnn-example"></span><a class="reference internal image-reference" href="../../../_images/cnn.jpeg"><img alt="cnn" src="../../../_images/cnn.jpeg" style="width: 80%;" /></a>
<p class="caption"><span class="caption-number">Fig. 1.7 </span><span class="caption-text">Example of CNN architecture to classify handwritten digits.</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>Let see some possible <cite>layer</cite> that you can use in a CNN:</p>
<div class="section" id="convolution-layer">
<h3><span class="section-number">1.1.1. </span>Convolution layer<a class="headerlink" href="#convolution-layer" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center" id="id3">
<span id="cnn-covolution"></span><a class="reference internal image-reference" href="../../../_images/covolution_stride_padding.gif"><img alt="covolution" src="../../../_images/covolution_stride_padding.gif" style="width: 80%;" /></a>
<p class="caption"><span class="caption-number">Fig. 1.8 </span><span class="caption-text">Convolutional layers example with differnt <code class="docutils literal notranslate"><span class="pre">stride</span></code> and <code class="docutils literal notranslate"><span class="pre">padding</span></code> hyperparameters.</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p>The convolutional layer is the Neural Networks (NN) solution to replace the fully connected Perceptron layer.
When dealing with n-dimensional tensor (with n &gt; 1), the memory required to build a classic NN raises fast and reaches a value that makes
the use of this technique unuseful. The solution is, instead to connect each neuron to every input pixel, we use a <cite>filter</cite> (a.k.a. <cite>kernel</cite>)
which scans the previous layer’s input, and the resulting product (convolution) builds the output.
The main and crucial hyperparameter of this layer is the <code class="docutils literal notranslate"><span class="pre">stride</span></code> and <code class="docutils literal notranslate"><span class="pre">padding</span></code>, <a class="reference internal" href="#cnn-covolution"><span class="std std-numref">Fig. 1.8</span></a>:</p>
<p><code class="docutils literal notranslate"><span class="pre">Stride</span></code> is the number of pixels shifts over the input matrix.
When the stride is 1 then we move filters to 1 pixel at a time.
When the stride is 2, then we move the filters to 2 pixels at a time and so on.</p>
<p><code class="docutils literal notranslate"><span class="pre">Padding</span></code> is the amount of zeoro-element added to an image (input tensor) when it is being processed by the kernel of a CNN.</p>
<p>Changin the <code class="docutils literal notranslate"><span class="pre">stride</span></code> and <code class="docutils literal notranslate"><span class="pre">padding</span></code> chenge the output layer shape, and the output width or height can be compute with the
<a class="reference internal" href="#equation-stide-padding">(1.1)</a></p>
<div class="math notranslate nohighlight" id="equation-stide-padding">
<span class="eqno">(1.1)<a class="headerlink" href="#equation-stide-padding" title="Permalink to this equation">¶</a></span>\[O = \dfrac{I - K + 2P}{S} +1\]</div>
<p>where <span class="math notranslate nohighlight">\(O\)</span> is the output width/height, <span class="math notranslate nohighlight">\(I\)</span> is the input width/height, <span class="math notranslate nohighlight">\(K\)</span> is the kernel size,
<span class="math notranslate nohighlight">\(P\)</span> is teh padding and <span class="math notranslate nohighlight">\(S\)</span> is the stide.</p>
<p>Note with a kernel of 3x3 (<span class="math notranslate nohighlight">\(K=3\)</span>) we have that settintg the <code class="docutils literal notranslate"><span class="pre">stride=None</span></code> and <code class="docutils literal notranslate"><span class="pre">padding=2</span></code> the input and output layer
have the same size (this is usualy called “same” padding).</p>
</div>
<div class="section" id="pooling-layer">
<h3><span class="section-number">1.1.2. </span>Pooling layer<a class="headerlink" href="#pooling-layer" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center" id="id4">
<span id="cnn-pooling"></span><a class="reference internal image-reference" href="../../../_images/pooling.png"><img alt="covolution" src="../../../_images/pooling.png" style="width: 40%;" /></a>
<p class="caption"><span class="caption-number">Fig. 1.9 </span><span class="caption-text">Pooling layer.</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
<p>A pooling layer, <a class="reference internal" href="#cnn-pooling"><span class="std std-numref">Fig. 1.9</span></a>, is nothing but reducing the information size. While in convolution out NN is “learning” in this layer, we
are reducing the data size. Therefore we are losing info, but we are highlighting the only feature that matters.</p>
<div class="toctree-wrapper compound">
</div>
</div>
</div>
<div class="section" id="colab">
<h2><span class="section-number">1.2. </span>Colab<a class="headerlink" href="#colab" title="Permalink to this headline">¶</a></h2>
<p>Colab is a free Jupyter notebook environment that runs entirely in the cloud. Here we can use all the libraries available for python,
and for working with the Neural network, we have a lot of them. To name some: <a class="reference external" href="https://scikit-learn.org/stable/index.html">scikit-learn</a>, <a class="reference external" href="https://pytorch.org/">pyThorch</a> and  <a class="reference external" href="https://www.tensorflow.org/">Tensorflow</a>.</p>
<p>In this tutorial, we are going to use the latter one: <strong>Tensorflow (TF)</strong>.</p>
<p>Let’s go to Colab <a class="reference external" href="https://colab.research.google.com/">https://colab.research.google.com/</a> open an account and a new notebook.
It is a Jupyter notebook; therefore, we can write and run the <cite>blocks</cite> element. These can be a <cite>code block</cite> or a <cite>text block</cite>, <a class="reference internal" href="#colab-block"><span class="std std-numref">Fig. 1.10</span></a>.
In the first one, we can write everything is python readable, in the second everything si <a class="reference external" href="https://it.wikipedia.org/wiki/Markdown">Markdown</a>
readable. To run the block, we can click on the “play” button on the side or use the shortcut <code class="docutils literal notranslate"><span class="pre">shift+enter</span></code>.</p>
<div class="figure align-center" id="id5">
<span id="colab-block"></span><a class="reference internal image-reference" href="../../../_images/colab_block.png"><img alt="Coolab blocks view" src="../../../_images/colab_block.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-number">Fig. 1.10 </span><span class="caption-text">Coolab blocks view.</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</div>
<p>Before to everything, we have to set up the cloud driver, go to the “runtime” drop-down menu, select
“change runtime type” and choose TPU in the hardware accelerator drop-down menu (<a class="reference internal" href="#colab-runtime"><span class="std std-numref">Fig. 1.11</span></a>).
(TPU stand for Tensor Processing Unit (TPU) is an AI accelerator application-specific integrated circuit (ASIC) developed by Google)</p>
<div class="figure align-center" id="id6">
<span id="colab-runtime"></span><a class="reference internal image-reference" href="../../../_images/runtime.png"><img alt="Change runtime type popup" src="../../../_images/runtime.png" style="width: 35%;" /></a>
<p class="caption"><span class="caption-number">Fig. 1.11 </span><span class="caption-text">Change runtime type popup.</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="handwritten-number-recognition-with-cnn">
<h2><span class="section-number">1.3. </span>Handwritten number recognition with CNN<a class="headerlink" href="#handwritten-number-recognition-with-cnn" title="Permalink to this headline">¶</a></h2>
<p>To build a NN, we go throw the following steps:</p>
<ol class="arabic simple">
<li><p>Environment set-up.</p></li>
<li><p>Data collection and preprocessing.</p></li>
<li><p>Model building.</p></li>
<li><p>Model compiling (loss function, training strategy)</p></li>
<li><p>Training.</p></li>
<li><p>Validation.</p></li>
</ol>
<p>For this tutorial, we are going to build a CNN to recognize the handwritten number present in the database MNIST.
If you want to use the top in the market go to see the last model winner of the famous <a class="reference external" href="http://www.image-net.org/challenges/LSVRC/index">Image-Net</a> challenge</p>
<div class="section" id="environment-set-up">
<h3><span class="section-number">1.3.1. </span>Environment set-up<a class="headerlink" href="#environment-set-up" title="Permalink to this headline">¶</a></h3>
<p>First of all let’s open a section by createing a new <em>Text block</em> and writing inside the code:</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span><span class="gh">#</span> Libraries
</pre></div>
</div>
<p>Then we load all the python libraries needed for this project.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="o">%</span><span class="k">tensorflow_version</span> 2.x             # We want use TF version &gt;= 2.0
<span class="gp">   ...: </span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>             <span class="c1"># The NN backend</span>
<span class="gp">   ...: </span><span class="kn">from</span> <span class="nn">tensorflow.python.keras</span> <span class="kn">import</span> <span class="n">layers</span><span class="p">,</span> <span class="n">Sequential</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">regularizers</span>
<span class="gp">   ...: </span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>     <span class="c1"># To plot</span>
<span class="gp">   ...: </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>                  <span class="c1"># To work with arrays</span>
<span class="gp">   ...: </span><span class="kn">import</span> <span class="nn">random</span>
<span class="gp">   ...: </span><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>               <span class="c1"># To show progressive bar</span>
</pre></div>
</div>
<p>We check if the TPU is working.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [2]: </span><span class="c1"># Check that we are using a TPU</span>
<span class="gp">   ...: </span><span class="k">try</span><span class="p">:</span>
<span class="gp">   ...: </span>    <span class="n">tpu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">cluster_resolver</span><span class="o">.</span><span class="n">TPUClusterResolver</span><span class="p">()</span>  <span class="c1"># TPU detection</span>
<span class="gp">   ...: </span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running on TPU &#39;</span><span class="p">,</span> <span class="n">tpu</span><span class="o">.</span><span class="n">cluster_spec</span><span class="p">()</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;worker&#39;</span><span class="p">])</span>
<span class="gp">   ...: </span><span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<span class="gp">   ...: </span>    <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="s1">&#39;ERROR: Not connected to a TPU runtime; please swithc runtimes  Runtime &gt; Change Runtime Type &gt; TPU!&#39;</span><span class="p">)</span>

<span class="go">Running on TPU  [&#39;10.115.241.50:8470&#39;]</span>
</pre></div>
</div>
</div>
<div class="section" id="data-collection-and-preprocessing">
<span id="section-data-collection"></span><h3><span class="section-number">1.3.2. </span>Data collection and preprocessing<a class="headerlink" href="#data-collection-and-preprocessing" title="Permalink to this headline">¶</a></h3>
<p>In this part we downolad and look at out dataset.
The MNIST (Modified database National Institute of Standards and Technology) is a collection of 70.000 handwritten 10-digit images,
downsampled in size (28 × 28 pixels), in black and white and therefore with only one color channel.</p>
<p>First, we open a new section of our Notebook.</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span><span class="gh">#</span> Data collection and preprocessing
</pre></div>
</div>
<p>Then we load the database.
Because it is a standard database (a sort of <em>Hello World</em> for CNN), it is already included in TF,
so we only need to run the following function:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [3]: </span><span class="n">mnist</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span>
<span class="gp">   ...: </span><span class="p">(</span><span class="n">train_images</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">),</span> <span class="p">(</span><span class="n">test_images</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="go">Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/mnist.npz</span>
<span class="go">11493376/11490434 [==============================] - 0s 0us/step</span>
</pre></div>
</div>
<p>Let’s look how many images we have:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [4]: </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train Images:</span><span class="si">{</span><span class="n">train_images</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">   ...: </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train Labels:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_labels</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">   ...: </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test Images:</span><span class="si">{</span><span class="n">test_images</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="gp">   ...: </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test Labels:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_labels</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="go">Train Images:(60000, 28, 28)</span>
<span class="go">Train Labels:60000</span>
<span class="go">Test Images:(10000, 28, 28)</span>
<span class="go">Test Labels:10000</span>
</pre></div>
</div>
<p>Thus we have 60k images for the training and 10k for the test (86%-14% split).</p>
<p>Now let see what there is inside this database by randomly plotting 36 pictures:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [5]: </span><span class="c1"># set a proper figure dimension</span>
<span class="gp">   ...: </span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="gp">   ...:</span>
<span class="gp">   ...: </span><span class="c1"># pick 36 random digits in range 0-59999</span>
<span class="gp">   ...: </span><span class="c1"># inner bound is inclusive, outer bound exclusive</span>
<span class="gp">   ...: </span><span class="n">random_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="mi">60000</span><span class="p">,</span><span class="mi">36</span><span class="p">)</span>
<span class="gp">   ...:</span>
<span class="gp">   ...: </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">36</span><span class="p">):</span>
<span class="gp">   ...: </span>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">   ...: </span>    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
<span class="gp">   ...: </span>    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="gp">   ...: </span>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">   ...: </span>    <span class="n">image_ind</span> <span class="o">=</span> <span class="n">random_inds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="gp">   ...: </span>    <span class="c1"># show images using a binary color map (i.e. Black and White only)</span>
<span class="gp">   ...: </span>    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">train_images</span><span class="p">[</span><span class="n">image_ind</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">binary</span><span class="p">)</span>
<span class="gp">   ...: </span>    <span class="c1"># set the image label</span>
<span class="gp">   ...: </span>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">train_labels</span><span class="p">[</span><span class="n">image_ind</span><span class="p">])</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../../_images/mnist_out.png"><img alt="MNIST" class="align-center" src="../../../_images/mnist_out.png" style="width: 50%;" /></a>
<p>In all Neural network, we work with floating-point number that has to be in the interval <span class="math notranslate nohighlight">\([0, 1]\)</span>.
Since our data is in RGB thus assume an integer value between 0 to 255 we perform the following normalization:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [6]: </span><span class="c1"># from range 0-255 to 0-1</span>
<span class="gp">   ...: </span><span class="n">train_images</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">train_images</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">255.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="gp">   ...: </span><span class="n">train_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">train_labels</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<span class="gp">   ...: </span><span class="n">test_images</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">test_images</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">255.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="gp">   ...: </span><span class="n">test_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_labels</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="model-building">
<h3><span class="section-number">1.3.3. </span>Model building<a class="headerlink" href="#model-building" title="Permalink to this headline">¶</a></h3>
<p>Now we are going to build our basic CNN</p>
<p>First, we open a new section of our Notebook.</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span><span class="gh">#</span> Model building
</pre></div>
</div>
<p>Then, using the TF (Keras) API we will simply build the VGG16 as follow:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [7]: </span><span class="k">def</span> <span class="nf">create_model</span><span class="p">():</span>
<span class="gp">   ...: </span>    <span class="c1"># Input block</span>
<span class="gp">   ...: </span>    <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">train_images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">train_images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">],</span>
<span class="gp">   ...: </span>                                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
<span class="gp">   ...: </span>    <span class="c1"># Block 1</span>
<span class="gp">   ...: </span>    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span>
<span class="gp">   ...: </span>            <span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;block1_conv1&#39;</span><span class="p">)(</span><span class="n">input_tensor</span><span class="p">)</span>
<span class="gp">   ...: </span>    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;block1_pool&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">   ...: </span>    <span class="c1"># Block 2</span>
<span class="gp">   ...: </span>    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span>
<span class="gp">   ...: </span>            <span class="mi">36</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;block2_conv1&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">   ...: </span>    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;block2_pool&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">   ...: </span>    <span class="c1"># Classification block</span>
<span class="gp">   ...: </span>    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;flatten&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">   ...: </span>    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fc1&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">   ...: </span>    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">   ...: </span>    <span class="n">prob</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">,</span>
<span class="gp">   ...: </span>                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;predictions&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">   ...:</span>
<span class="gp">   ...: </span>    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">,</span> <span class="n">prob</span><span class="p">)</span>
<span class="gp">   ...: </span>    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
<p>Let us call the function and build the model</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [8]: </span><span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">()</span>
</pre></div>
</div>
<p>And let us see if if is all in order</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [9]: </span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="model-compiling">
<h3><span class="section-number">1.3.4. </span>Model compiling<a class="headerlink" href="#model-compiling" title="Permalink to this headline">¶</a></h3>
<p>Now we have to “compile” the model. Which means choose the loss fanction, the traingin strategy and optimizer (and learning rate),
and the right metrics for the evaulation.</p>
<ul class="simple">
<li><p><strong>Loss Function</strong>: it is the critera by which to evaluate the accuracy of the model. The traing goal is to minimize this function. For this case we choose the <a class="reference external" href="https://en.wikipedia.org/wiki/Cross_entropy">Sparse Categorical Crossentropy</a></p></li>
<li><p><strong>Optimizer</strong>: It defines the model weights serchin criteria to minimize the loss function. In this tutotrial we choose the common <a class="reference external" href="https://en.wikipedia.org/wiki/Stochastic_gradient_descent#Adam">Adam</a></p></li>
<li><p><strong>Metrics</strong>: It the wey yo evaulate the goodness of the model. For this kind of model usualy we choose the <a class="reference external" href="https://en.wikipedia.org/wiki/Accuracy_and_precision">Accuracy</a></p></li>
</ul>
<p>As usual let us open a new section:</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span><span class="gh">#</span> Model compiling
</pre></div>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [10]: </span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-2</span>
<span class="gp">   ...: </span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>
<span class="gp">   ...: </span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;sparse_categorical_crossentropy&#39;</span>
<span class="gp">   ...: </span><span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
<span class="gp">   ...:</span>
<span class="gp">   ...: </span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
<span class="gp">   ...: </span>    <span class="n">optimizer</span><span class="p">,</span>
<span class="gp">   ...: </span>    <span class="n">loss</span><span class="p">,</span>
<span class="gp">   ...: </span>    <span class="n">metrics</span><span class="p">,</span>
<span class="gp">   ...: </span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="training">
<h3><span class="section-number">1.3.5. </span>Training<a class="headerlink" href="#training" title="Permalink to this headline">¶</a></h3>
<p>Since it is impossible to feed all our database in a one-shot, we split it into smaller sub-sets called <em>batch</em> then we train the model multiple times to allow the convergence.</p>
<p>As usual let us open a new section:</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span><span class="gh">#</span> Training
</pre></div>
</div>
<p>And let us train the model with the <cite>train_images</cite> dataset.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [10]: </span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">256</span>
<span class="gp">   ...: </span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="gp">   ...:</span>
<span class="gp">   ...: </span><span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
<span class="gp">   ...: </span>    <span class="n">train_images</span><span class="p">,</span>
<span class="gp">   ...: </span>    <span class="n">train_labels</span><span class="p">,</span>
<span class="gp">   ...: </span>    <span class="n">batch_size</span><span class="p">,</span>
<span class="gp">   ...: </span>    <span class="n">epochs</span><span class="p">,</span>
<span class="gp">   ...: </span><span class="p">)</span>
</pre></div>
</div>
<p>At the end of the training, we can plot the learning curve of the model:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [11]: </span><span class="c1"># Plot traing loop</span>
<span class="gp">   ...: </span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
<span class="gp">   ...: </span><span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="gp">   ...: </span><span class="n">epochs_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
<span class="gp">   ...:</span>
<span class="gp">   ...: </span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mf">4.5</span><span class="p">))</span>
<span class="gp">   ...: </span><span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="s1">&#39;111&#39;</span><span class="p">)</span>
<span class="gp">   ...: </span><span class="n">ax_twin</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="gp">   ...: </span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs_i</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="gp">   ...: </span><span class="n">ax_twin</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs_i</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="gp">   ...: </span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epochs [-]&#39;</span><span class="p">)</span>
<span class="gp">   ...: </span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy [%]&#39;</span><span class="p">)</span>
<span class="gp">   ...: </span><span class="n">ax_twin</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss [-]&#39;</span><span class="p">)</span>
<span class="gp">   ...: </span><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="gp">   ...: </span><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../../_images/learning_curve.png"><img alt="learning curve" class="align-center" src="../../../_images/learning_curve.png" style="width: 70%;" /></a>
</div>
<div class="section" id="results">
<h3><span class="section-number">1.3.6. </span>Results<a class="headerlink" href="#results" title="Permalink to this headline">¶</a></h3>
<p>We can now visulize the result.</p>
<p>As usual let us open a new section:</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span><span class="gh">#</span> Results
</pre></div>
</div>
<p>Then we have to collect the prediction for the <em>Test set</em> <code class="docutils literal notranslate"><span class="pre">test_images</span></code></p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [12]: </span><span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_images</span><span class="p">)</span>
</pre></div>
</div>
<p>We write some function useful to visualizing the data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define classnames for improved readability</span>
<span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Zero&#39;</span><span class="p">,</span> <span class="s1">&#39;One&#39;</span><span class="p">,</span> <span class="s1">&#39;Two&#39;</span><span class="p">,</span> <span class="s1">&#39;Three&#39;</span><span class="p">,</span> <span class="s1">&#39;Four&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Five&#39;</span><span class="p">,</span> <span class="s1">&#39;Six&#39;</span><span class="p">,</span> <span class="s1">&#39;Seven&#39;</span><span class="p">,</span> <span class="s1">&#39;Eight&#39;</span><span class="p">,</span> <span class="s1">&#39;Nine&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">plot_image</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">predictions_array</span><span class="p">,</span> <span class="n">true_label</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
    <span class="n">predictions_array</span><span class="p">,</span> <span class="n">true_label</span><span class="p">,</span> <span class="n">img</span> <span class="o">=</span> <span class="n">predictions_array</span><span class="p">,</span> <span class="n">true_label</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">binary</span><span class="p">)</span>

    <span class="n">predicted_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predictions_array</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">predicted_label</span> <span class="o">==</span> <span class="n">true_label</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{:2.0f}</span><span class="s2">% (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_names</span><span class="p">[</span><span class="n">predicted_label</span><span class="p">],</span>
                                    <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">predictions_array</span><span class="p">),</span>
                                    <span class="n">class_names</span><span class="p">[</span><span class="n">true_label</span><span class="p">]),</span>
                                    <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_value_array</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">predictions_array</span><span class="p">,</span> <span class="n">true_label</span><span class="p">):</span>
    <span class="n">predictions_array</span><span class="p">,</span> <span class="n">true_label</span> <span class="o">=</span> <span class="n">predictions_array</span><span class="p">,</span> <span class="n">true_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
    <span class="n">thisplot</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">predictions_array</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#777777&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">predicted_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predictions_array</span><span class="p">)</span>

    <span class="n">thisplot</span><span class="p">[</span><span class="n">predicted_label</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">thisplot</span><span class="p">[</span><span class="n">true_label</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>And let us see the prediction versus the ground truth:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [13]: </span><span class="n">num_rows</span> <span class="o">=</span> <span class="mi">5</span>
<span class="gp">   ...: </span><span class="n">num_cols</span> <span class="o">=</span> <span class="mi">3</span>
<span class="gp">   ...: </span><span class="n">num_images</span> <span class="o">=</span> <span class="n">num_rows</span><span class="o">*</span><span class="n">num_cols</span>
<span class="gp">   ...: </span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">num_cols</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">num_rows</span><span class="p">))</span>
<span class="gp">   ...: </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">):</span>
<span class="gp">   ...: </span>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">num_cols</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">   ...: </span>    <span class="n">plot_image</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">test_labels</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">test_images</span><span class="p">))</span>
<span class="gp">   ...: </span>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">num_cols</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">   ...: </span>    <span class="n">plot_value_array</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">test_labels</span><span class="p">)</span>
<span class="gp">   ...: </span><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="gp">   ...: </span><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="excercise">
<h2><span class="section-number">1.4. </span>Excercise<a class="headerlink" href="#excercise" title="Permalink to this headline">¶</a></h2>
<p>Following the same steps, build a similar CNN for the <em>Fashion MNIST</em> database <a class="reference external" href="https://github.com/zalandoresearch/fashion-mnist">https://github.com/zalandoresearch/fashion-mnist</a>.
First test if all is working by only changing the <a class="reference external" href="Section_data_collection">Data collection and preprocessing</a> command with:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [3]: </span><span class="n">mnist</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">fashion_mnist</span>
<span class="gp">   ...: </span><span class="p">(</span><span class="n">train_images</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">),</span> <span class="p">(</span><span class="n">test_images</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</pre></div>
</div>
<p>Then, one at the time, add the following features at your code:</p>
<ol class="arabic simple">
<li><p>Build a custom data pipeline (see guide <a class="reference external" href="https://www.tensorflow.org/guide/data">Tensorflow Data</a>) to load the <em>Fashion MNIST</em>.</p></li>
<li><p>Add an additional convolutional block with 48 3x3 kernels to the model.</p></li>
<li><p>Write the training loop from scratch (see guide <a class="reference external" href="https://www.tensorflow.org/guide/keras/writing_a_training_loop_from_scratch">Tensorflow Training loop</a>).</p></li>
<li><p>Add to the model callback option to save checkpoint every 10 epochs (see guide <a class="reference external" href="https://www.tensorflow.org/guide/checkpoint">Tensorflow Checkpoint</a>).</p></li>
<li><p>Save the model (see guide <a class="reference external" href="https://www.tensorflow.org/guide/saved_model">Tensorflow Save model</a>).</p></li>
</ol>
<p>For help with all these tasks, consult the <a class="reference external" href="https://www.tensorflow.org/guide">Tensorflow Guide</a>, and the internet is full of answers to your question.</p>
<div class="toctree-wrapper compound">
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../index.html" class="btn btn-neutral float-left" title="Tutorials" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Multi-Scale ModeLing Laboratory (SMaLL) POLITECNICO DI TORINO (Department of Energy &#34;Galileo Ferraris&#34; (DENERG)), ITA . All rights reserved.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>